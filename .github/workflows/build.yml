name: Build chiOS

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

env:
  IMAGE_NAME: chios
  IMAGE_REGISTRY: ghcr.io/matoval

jobs:
  # ─────────────────────────────────────────────────────────────────────────
  # Job 1: Build and push the chiOS OCI image
  # ─────────────────────────────────────────────────────────────────────────
  build-image:
    name: Build OCI Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    outputs:
      image_ref: ${{ steps.meta.outputs.sha_tag }}
      is_release: ${{ steps.meta.outputs.is_release }}
      version:    ${{ steps.meta.outputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up image metadata
        id: meta
        run: |
          IMAGE_FULL="${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}"
          SHA_SHORT=$(git rev-parse --short HEAD)
          echo "sha_tag=${IMAGE_FULL}:${SHA_SHORT}" >> $GITHUB_OUTPUT
          echo "latest_tag=${IMAGE_FULL}:latest"    >> $GITHUB_OUTPUT
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
            echo "version=${VERSION}"                         >> $GITHUB_OUTPUT
            echo "version_tag=${IMAGE_FULL}:${VERSION}"       >> $GITHUB_OUTPUT
            echo "is_release=true"                            >> $GITHUB_OUTPUT
          else
            echo "version=dev-${SHA_SHORT}"  >> $GITHUB_OUTPUT
            echo "is_release=false"          >> $GITHUB_OUTPUT
          fi

      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install buildah
        run: |
          sudo apt-get update -y
          sudo apt-get install -y buildah

      - name: Build OCI image
        id: build
        run: |
          buildah build \
            --tag "${{ steps.meta.outputs.sha_tag }}" \
            --tag "${{ steps.meta.outputs.latest_tag }}" \
            --file Containerfile \
            .

      - name: Push to GHCR
        if: github.event_name != 'pull_request'
        run: |
          buildah push "${{ steps.meta.outputs.sha_tag }}"
          buildah push "${{ steps.meta.outputs.latest_tag }}"

      - name: Tag and push version tag
        if: steps.meta.outputs.is_release == 'true' && github.event_name != 'pull_request'
        run: |
          buildah tag "${{ steps.meta.outputs.sha_tag }}" "${{ steps.meta.outputs.version_tag }}"
          buildah push "${{ steps.meta.outputs.version_tag }}"

  # ─────────────────────────────────────────────────────────────────────────
  # Job 2: Build the live installer ISO (version tags only)
  #
  # Runs the entire job inside a privileged Fedora 42 container so that
  # livemedia-creator has direct access to loop devices and dnf without
  # any container-in-container nesting.
  # ─────────────────────────────────────────────────────────────────────────
  build-iso:
    name: Build Installer ISO
    runs-on: ubuntu-latest
    container:
      image: quay.io/fedora/fedora:42
      options: --privileged
    needs: build-image
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
      packages: read

    steps:
      - name: Install build dependencies
        run: |
          dnf install -y \
            git \
            lorax \
            anaconda \
            calamares \
            genisoimage \
            squashfs-tools \
            syslinux \
            grub2-efi-x64 \
            shim-x64

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Stage Calamares configuration and build ISO
        run: |
          set -euxo pipefail

          VERSION="${GITHUB_REF#refs/tags/}"
          ISO_NAME="chiOS-${VERSION}-installer.iso"
          CHIOS_IMAGE="${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}"

          echo "ISO_NAME=${ISO_NAME}" >> "${GITHUB_ENV}"

          # Stage Calamares config into /etc/calamares
          mkdir -p /etc/calamares/modules/chi-install
          mkdir -p /etc/calamares/branding/chios

          cp installer/calamares/settings.conf          /etc/calamares/settings.conf
          cp -r installer/calamares/branding/chios/.    /etc/calamares/branding/chios/
          cp installer/calamares/modules/partition.conf /etc/calamares/modules/
          cp installer/calamares/modules/users.conf     /etc/calamares/modules/
          cp installer/calamares/modules/finished.conf  /etc/calamares/modules/
          cp installer/calamares/modules/chi-install/module.desc \
             /etc/calamares/modules/chi-install/
          cp installer/calamares/modules/chi-install/main.py \
             /etc/calamares/modules/chi-install/

          # Inject the target OCI image URL into the install module
          sed -i "s|CHIOS_IMAGE_PLACEHOLDER|${CHIOS_IMAGE}|g" \
            /etc/calamares/modules/chi-install/main.py

          # Build the live ISO
          # Note: livemedia-creator requires --resultdir to NOT exist beforehand
          mkdir -p /tmp/livemedia-tmp
          livemedia-creator \
            --ks installer/chiOS-installer.ks \
            --no-virt \
            --project "chiOS" \
            --make-iso \
            --iso-name "${ISO_NAME}" \
            --resultdir /iso-output \
            --tmp /tmp/livemedia-tmp

      - name: Locate and rename ISO
        run: |
          echo "==> Contents of /iso-output:"
          find /iso-output -type f 2>/dev/null || echo "  (empty or missing)"

          # lorax may name the ISO 'boot.iso' regardless of --iso-name; find and rename it
          FOUND=$(find /iso-output -name "*.iso" -type f 2>/dev/null | head -1)
          if [ -z "$FOUND" ]; then
            echo "ERROR: No .iso file found in /iso-output"
            exit 1
          fi
          echo "Found ISO at: $FOUND"
          TARGET="/iso-output/${ISO_NAME}"
          if [ "$FOUND" != "$TARGET" ]; then
            mv "$FOUND" "$TARGET"
            echo "Renamed to: $TARGET"
          fi

      - name: Generate SHA-256 checksum
        run: |
          cd /iso-output
          sha256sum "${ISO_NAME}" > SHA256SUMS
          cat SHA256SUMS

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "chiOS ${{ github.ref_name }}"
          body: |
            ## chiOS ${{ github.ref_name }}

            An AI-native OS that lets any knowledge-level user do anything — just ask chi.

            ### Install chiOS

            1. Download `${{ env.ISO_NAME }}` below
            2. Flash to USB with [Balena Etcher](https://etcher.balena.io/) or `dd`:
               ```
               sudo dd if=${{ env.ISO_NAME }} of=/dev/sdX bs=4M status=progress
               ```
            3. Boot your machine from the USB drive
            4. Follow the graphical Calamares installer
            5. Reboot and log in with chi-greeter

            ### What's included
            - **chi-overlay** — AI assistant powered by Claude (local Ollama available)
            - **chi-shell** — Minimal GTK4 desktop panel
            - **chi-greeter** — Polished login screen
            - **Conversation history** with data viewer and delete controls
            - Automatic OS updates via bootc

            ### Verify download
            ```
            sha256sum -c SHA256SUMS
            ```
          files: |
            /iso-output/${{ env.ISO_NAME }}
            /iso-output/SHA256SUMS
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
