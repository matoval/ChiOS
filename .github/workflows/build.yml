name: Build chiOS OCI Image

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

env:
  IMAGE_NAME: chios
  IMAGE_REGISTRY: ghcr.io/matoval

jobs:
  build:
    name: Build OCI Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up image metadata
        id: meta
        run: |
          IMAGE_FULL="${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}"
          echo "image=${IMAGE_FULL}" >> $GITHUB_OUTPUT
          echo "sha_tag=${IMAGE_FULL}:$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "latest_tag=${IMAGE_FULL}:latest" >> $GITHUB_OUTPUT
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
            echo "version_tag=${IMAGE_FULL}:${VERSION}" >> $GITHUB_OUTPUT
            echo "is_release=true" >> $GITHUB_OUTPUT
          else
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi

      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install buildah
        run: |
          sudo apt-get update -y
          sudo apt-get install -y buildah

      - name: Build OCI image
        id: build
        run: |
          buildah build \
            --tag "${{ steps.meta.outputs.sha_tag }}" \
            --tag "${{ steps.meta.outputs.latest_tag }}" \
            --file Containerfile \
            .

      - name: Push to GHCR
        if: github.event_name != 'pull_request'
        run: |
          buildah push "${{ steps.meta.outputs.sha_tag }}"
          buildah push "${{ steps.meta.outputs.latest_tag }}"

      - name: Tag and push version tag
        if: steps.meta.outputs.is_release == 'true' && github.event_name != 'pull_request'
        run: |
          buildah tag "${{ steps.meta.outputs.sha_tag }}" "${{ steps.meta.outputs.version_tag }}"
          buildah push "${{ steps.meta.outputs.version_tag }}"

  build-iso:
    name: Build ISO
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Podman
        run: |
          sudo apt-get update -y
          sudo apt-get install -y podman

      - name: Log in to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login ghcr.io \
            -u "${{ github.actor }}" --password-stdin

      - name: Build ISO
        run: |
          mkdir -p output
          sudo podman run --rm --privileged \
            -v /var/lib/containers/storage:/var/lib/containers/storage \
            -v "$(pwd)/output:/output" \
            quay.io/centos-bootc/bootc-image-builder:latest \
            --type iso \
            ghcr.io/matoval/chios:latest

      - name: Upload ISO to Release
        uses: softprops/action-gh-release@v2
        with:
          files: output/bootiso/install.iso
          name: chiOS ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
